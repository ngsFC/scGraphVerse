---
title: "scGRN testing"
author: "Francesco Cecere"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    theme: cerulean
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set("/home/francescoc/Desktop/scGRN_simulation/R")
```

```{r global options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.height=5, fig.width=10, fig.align = "center", class.source = "foldable", timing = TRUE)
```

```{r libraries, timing = TRUE}
library(GENIE3)
library(doParallel)
library(igraph)
library(tidyverse)
library(DT)
library(reticulate)
library(learn2count)
library(rbenchmark)
library(reshape2)
library(gridExtra)
```

```{r}
source("dropo.R")
source("generate_adjacency.R")
source("adj_cutoff.R")
source("simmetric.R")
source("pscores.R")
source("plotg.R")
source("compare_consensus.R")
source("earlyj.R")

```


# Load data

```{r}
adjm <- read.table("./../data/adjacency_matrix.csv", header = T, row.names = 1, sep = ",") %>% as.matrix()
link_list_genie3_list <- readRDS("./../analysis/genie3_network_list.RDS")
elink_list_genie3_list <- readRDS("./../analysis/early_genie3_network_list.RDS")
all_grn_links <- readRDS("./../analysis/grnboost2_network_list.RDS")
```



# Early Join

```{r}
elink_list_genie3_list <- simmetric(elink_list_genie3_list, weight_function = "mean")
elink_list_genie3_list[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 simmetric output")
```

```{r}
adj_matrix_list <- generate_adjacency(elink_list_genie3_list)

adj_matrix_list[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 adjacency")

adj_matrix_list <- adj_cutoff(adj_matrix_list, weight_quantile = 0.80)

adj_matrix_list$binary_matrices[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 adjacency")

```



```{r}
scores <- pscores(adjm, adj_matrix_list$binary_matrices)

print(scores$Jaccard_Heatmap)
print(scores$Metrics_Barplot)

scores$Metrics_Results %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores")
```


```{r}
plots <- plotg(adj_matrix_list$binary_matrices)
```

```{r, fig.width=8,fig.width=10}
ajm_compared <- compare_consensus(adj_matrix_list$binary_matrices, adjm)
compare_consensus(adj_matrix_list$binary_matrices, adjm)
```


## Late Join


```{r}
link_list_genie3_list <- simmetric(link_list_genie3_list, weight_function = "mean")
link_list_genie3_list[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 simmetric output")
```


```{r}
adj_matrix_list <- generate_adjacency(link_list_genie3_list)

saveRDS(link_list_genie3_list, "./../analysis/genie3_adjacency_matrices.RDS.RDS")

adj_matrix_list[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 adjacency")

```



```{r}
scores <- pscores(adjm, adj_matrix_list)

print(scores$Jaccard_Heatmap)
print(scores$Metrics_Barplot)

scores$Metrics_Results %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores")
```


```{r}
plots <- plotg(adj_matrix_list)
```

```{r, fig.width=8,fig.width=10}
ajm_compared <- compare_consensus(adj_matrix_list, adjm)

compared_scores <- pscores(adjm,list(ajm_compared$Consensus_Matrix))
print(compared_scores$Jaccard_Heatmap)
print(compared_scores$Metrics_Barplot)
```


