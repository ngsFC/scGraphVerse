---
title: "scGRN testing"
author: "Francesco Cecere"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    theme: cerulean
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

# Flowchart

```{r setup, include=FALSE}
knitr::opts_chunk$set("/home/francescoc/Desktop/GRN_project/R")
```

```{r global options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.height=5, fig.width=10, fig.align = "center", class.source = "foldable")
```

```{r libraries}
library(GENIE3)
library(doParallel)
library(igraph)
library(tidyverse)
library(DT)
library(reticulate)
library(learn2count)
library(reshape2)
library(gridExtra)
library(DiagrammeR)
library(pROC)
library(JRF)
library(DiagrammeRsvg)
library(rsvg)
library(RColorBrewer)
library(ZILGM)
library(patchwork)
library(scales)
library(INetTool)
library(knitr)
library(microbenchmark)
library(Seurat)
library(biomaRt)
library(STRINGdb)
library(httr)
library(msigdbr)

use_python("/usr/bin/python3", required = TRUE)
arboreto <- import("arboreto.algo")
pandas <- import("pandas")
numpy <- import("numpy")

time <- list()
```

```{r myfunc}
source("generate_adjacency.R")
source("symmetrize.R")
source("pscores.R")
source("plotg.R")
source("compare_consensus.R")
source("create_consensus.R")
source("earlyj.R")
source("plotROC.R")
source("cutoff_adjacency.R")
source("infer_networks.R")
source("download_Atlas.R")
source("exploreCells.R")
source("topExp.R")
source("getAdj.R")
```

```{r flowchart, fig.width=9, fig.height=15}
grViz_output <- DiagrammeR::grViz("
digraph biological_workflow {
  # Set up the graph attributes
  graph [layout = dot, rankdir = TB]

  # Define consistent node styles
  node [shape = rectangle, style = filled, color = lightblue, fontsize = 12]

  # Define nodes for each step
  StartNode [label = 'Ground Thruth - String Regulatory Network', shape = oval, color = seagreen, fontcolor = black]
  AdjacencyMatrix [label = 'Thruth Adjacency Matrix', shape = rectangle, color = seagreen]
  SimulateData [label = 'Simulate Single-Cell Data', shape = rectangle, color = goldenrod]

  # Reconstruction using Three Packages
  LateIntegration [label = 'Late\nIntegration', shape = oval, color = khaki]
  EarlyIntegration [label = 'Early\nIntegration', shape = oval, color = khaki]
  Jointanalysis [label = 'Joint\nanalysis', shape = oval, color = khaki]
  

  # Process 
  earlyj [label = 'earlyj.R', shape=diamond, color=lightblue, fontcolor=black]
  networkinference [label = 'infer_networks.R\nGENIE3\nGRNBoost2\nZILGM\nJRF', shape = rectangle, color = goldenrod, fontcolor=black]
  symmetrize [label = 'symmetrize.R', shape = rectangle, color = goldenrod, fontcolor=black]
  plotROC [label = 'plotROC.R', shape=diamond, color=lightblue, fontcolor=black]
  generateadjacency [label='generate_adjacency.R\nWeighted Adjacency', shape=rectangle, color=goldenrod, fontcolor=black]
  cutoffadjacency [label='cutoff_adjacency.R\nBinary Adjacency', shape=rectangle, color=goldenrod, fontcolor=black]
  pscores [label='pscores.R\nTPR\nFPR\nF1\nAccuracy\nPrecision', shape=diamond, color=lightblue, fontcolor=black]
  voting [label='Voting\nUnion\nIntersection', shape=diamond, color=lightblue, fontcolor=black]
  plotgcompare  [label='plotg.R\ncompare_consesus.R\nPlot Graphs', shape=rectangle, color=goldenrod, fontcolor=black]

  # Define the workflow structure
  StartNode -> AdjacencyMatrix
  AdjacencyMatrix -> SimulateData
  SimulateData -> LateIntegration
  SimulateData -> EarlyIntegration
  SimulateData -> Jointanalysis
  EarlyIntegration -> earlyj
  earlyj -> networkinference
  LateIntegration -> networkinference
  Jointanalysis -> networkinference
  networkinference -> symmetrize
  symmetrize -> plotROC
  symmetrize -> generateadjacency
  generateadjacency -> cutoffadjacency
  cutoffadjacency -> pscores
  cutoffadjacency -> voting
  voting -> plotgcompare
  voting -> pscores
}
")

svg_code <- export_svg(grViz_output)
rsvg::rsvg_png(charToRaw(svg_code), "./../analysis/flowchart.png")

grViz_output
```

```{r flowchart, fig.width=9, fig.height=15}
grViz_output <- DiagrammeR::grViz("
digraph biological_workflow {
  # Set up the graph attributes
  graph [layout = dot, rankdir = TB]

  # Define consistent node styles
  node [shape = rectangle, style = filled, color = lightblue, fontsize = 12]

  # Define nodes for each step
  StartNode [label = 'Ground Thruth - String Regulatory Network', shape = oval, color = seagreen, fontcolor = black]
  AdjacencyMatrix [label = 'Thruth Adjacency Matrix', shape = rectangle, color = seagreen]
  SimulateData [label = 'Simulate Single-Cell Data', shape = rectangle, color = goldenrod]

  # Define the workflow structure
  StartNode -> AdjacencyMatrix
  AdjacencyMatrix -> SimulateData
}
")

svg_code <- export_svg(grViz_output)
rsvg::rsvg_png(charToRaw(svg_code), "./../analysis/flowchart1.png")

grViz_output


grViz_output <- DiagrammeR::grViz("
digraph biological_workflow {
  # Set up the graph attributes
  graph [layout = dot, rankdir = LR]

  # Define consistent node styles
  node [shape = rectangle, style = filled, color = lightblue, fontsize = 12]

  # Define nodes for each step
  SimulateData [label = 'Simulate Single-Cell Data', shape = rectangle, color = goldenrod]

  # Reconstruction using Three Packages
  LateIntegration [label = 'Late\nIntegration', shape = oval, color = khaki]
  EarlyIntegration [label = 'Early\nIntegration', shape = oval, color = khaki]
  Jointanalysis [label = 'Joint\nanalysis', shape = oval, color = khaki]
  

  # Process 
  networkinference [label = 'infer_networks.R', shape = rectangle, color = goldenrod, fontcolor=black]
  symmetrize [label = 'symmetrize.R', shape = rectangle, color = goldenrod, fontcolor=black]
  generateadjacency [label='generate_adjacency.R', shape=rectangle, color=goldenrod, fontcolor=black]
  cutoffadjacency [label='cutoff_adjacency.R', shape=rectangle, color=goldenrod, fontcolor=black]
  
  # Define the workflow structure
  SimulateData -> LateIntegration
  SimulateData -> EarlyIntegration
  SimulateData -> Jointanalysis
  EarlyIntegration -> networkinference
  LateIntegration -> networkinference
  Jointanalysis -> networkinference
  networkinference -> symmetrize
  symmetrize -> generateadjacency
  generateadjacency -> cutoffadjacency
  }
")

svg_code <- export_svg(grViz_output)
rsvg::rsvg_png(charToRaw(svg_code), "./../analysis/flowchart2.png")

grViz_output
```


# Tcell Ground Truth

```{r readGT, fig.width=5, fig.height=5}
#adjm <- read.table("./../data/Tcell_adjacency_matrix.csv", header = T, row.names = 1, sep = ",") %>% as.matrix()
#diag(adjm) <- 0

#adjm %>%
#    datatable(extensions = 'Buttons',
#            options = list(
#              dom = 'Bfrtip',
#              buttons = c('csv', 'excel'),
#              scrollX = TRUE,
#              pageLength = 10), 
#            caption = "Ground Truth")
options(timeout = 600)
seurat_url <- "https://datasets.cellxgene.cziscience.com/8e64f5c1-e56c-4b0a-bc83-1447fed2e7a4.rds"

seurat_object <- download_Atlas(seurat_url)
celltype <- exploreCells(seurat_object)

mart <- biomaRt::useEnsembl(biomart = "genes", dataset = "hsapiens_gene_ensembl")

topgenes <- topExp(seurat_object, "mature NK T cell", mart, 200)
wbadj <- getAdj(topgenes, mart, score_threshold = 700)

adjm <- as.matrix(wbadj[[2]])
```

```{r plotGT, fig.width=5, fig.height=5}
gtruth <- igraph::graph_from_adjacency_matrix(adjm, mode = "undirected", diag = F)

num_nodes <- vcount(gtruth)
num_edges <- ecount(gtruth)

set.seed(1234)
plot(gtruth, 
     main = paste("Ground Truth\nNodes:", num_nodes, "Edges:", num_edges),
     vertex.label.color = "black",
     vertex.size = 6, 
     edge.width = 2, 
     vertex.label = NA,
     vertex.color = "steelblue",
     layout = igraph::layout_with_fr)
```

# Simulate Data

```{r simulate matrices}
ncell <- 500
nodes <- nrow(adjm)

set.seed(1130)
mu_values <- c(3, 6, 9)
theta_values <- c(1, 0.7, 0.5)

count_matrices <- lapply(1:3, function(i) {
  set.seed(1130 + i)
  mu_i <- mu_values[i]
  theta_i <- theta_values[i]
  
  count_matrix_i <- simdata(n = ncell, p = nodes, B = adjm, family = "ZINB", 
                            mu = mu_i, mu_noise = 1, theta = theta_i, pi = 0.2)
  
  count_matrix_df <- as.data.frame(count_matrix_i)
  colnames(count_matrix_df) <- colnames(adjm)
  rownames(count_matrix_df) <- paste("cell", 1:nrow(count_matrix_df), sep = "")
  
  return(count_matrix_df)
})

count_matrices[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "Simulated count matrix")

saveRDS(count_matrices, "./../analysis/count_matrices.RDS")
```

# Matrices Integration
## Late Integration

### GENIE3

```{r GENIE3 late}
set.seed(1234)
time[["GENIE3_late_15Cores"]] <- system.time(
  genie3_late <- infer_networks(count_matrices, method="GENIE3", nCores = 15)
)

saveRDS(genie3_late, "./../analysis/genie3_late.RDS")

genie3_late[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 output")
```

#### symmetrize Output and ROC

```{r GENIE3 symmetrizeROC late}
genie3_late_wadj <- generate_adjacency(genie3_late, ground.truth = adjm)
sgenie3_late_wadj <- symmetrize(genie3_late_wadj, weight_function = "mean")
genie3_late_auc <- plotROC(sgenie3_late_wadj, adjm, plot_title = "ROC curve - GENIE3 Late Integration")

sgenie3_late_wadj[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 symmetrize output")
```

#### Generate Adjacency and Apply Cutoff

```{r GENIE3 cutoff late}
sgenie3_late_adj <- cutoff_adjacency(count_matrices = count_matrices,
                 weighted_adjm_list = sgenie3_late_wadj, 
                 ground.truth = adjm,
                 n = 3,
                 method = "GENIE3",
                 nCores = 15)

sgenie3_late_adj[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 adjacency")

```

#### Comparison with the Ground Truth

```{r GENIE3 metrics late}
scores.genie3.late.all <- pscores(adjm, sgenie3_late_adj)

scores.genie3.late.all$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores")
```

```{r GENIE3 plotg late}
plots <- plotg(sgenie3_late_adj)
```

```{r GENIE3 consensus and score late}
consesusm <- create_consensus(sgenie3_late_adj, method="vote")
consesusu <- create_consensus(sgenie3_late_adj, method="union")
consesunet <- create_consensus(adj_matrix_list = sgenie3_late_adj, weighted_list = sgenie3_late_wadj, method = "INet", threshold = 0.05, ncores = 15)

scores.genie3.late <- pscores(adjm, list(consesusm))
scoresu.genie3.late <- pscores(adjm, list(consesusu))
scoresnet.genie3.late <- pscores(adjm, list(consesunet))

scores.genie3.late$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores vote")

scores.genie3.late$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores union")

scoresnet.genie3.late$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores INet")

```

```{r GENIE3 compare late, fig.width=8,fig.width=10}
ajm_compared <- compare_consensus(consesusm, adjm)
ajm_compared <- compare_consensus(consesusu, adjm)
ajm_compared <- compare_consensus(consesunet, adjm)
```

### GRNBoost2

```{r GRNBoost2 late}
set.seed(1234)
time[["GRNBoost_late"]] <- system.time(
  grnb_late <- infer_networks(count_matrices, method="GRNBoost2")
)

saveRDS(grnb_late, "./../analysis/grnb_late.RDS")

grnb_late[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 output")
```

#### symmetrize Output and ROC

```{r GRNBoost2 symmetrizeROC late}
grnb_late_wadj <- generate_adjacency(grnb_late, ground.truth = adjm)
sgrnb_late_wadj <- symmetrize(grnb_late_wadj, weight_function = "mean")
grnb_late_auc <- plotROC(sgrnb_late_wadj, adjm, plot_title = "ROC curve - GRNBoost2 Late Integration")

sgrnb_late_wadj[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 symmetrize output")
```

#### Generate Adjacency and Apply Cutoff

```{r GRNBoost2 cutoff late}
sgrnb_late_adj <- cutoff_adjacency(count_matrices = count_matrices,
                 weighted_adjm_list = sgrnb_late_wadj, 
                 ground.truth = adjm,
                 n = 3,
                 method = "GRNBoost2")

sgrnb_late_adj[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 adjacency")

```

#### Comparison with the Ground Truth

```{r GRNBoost2 metrics late}
scores.grn.late.all <- pscores(adjm, sgrnb_late_adj)

scores.grn.late.all$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores")
```

```{r GRNBoost2 plotg late}
plots <- plotg(sgrnb_late_adj)
```

```{r GRNBoost2 consensus and score late}
consesusm <- create_consensus(sgrnb_late_adj, method="vote")
consesusu <- create_consensus(sgrnb_late_adj, method="union")
consesunet <- create_consensus(adj_matrix_list = sgrnb_late_adj, weighted_list = sgrnb_late_wadj, method = "INet", threshold = 0.05, ncores = 15)

scores.grn.late <- pscores(adjm, list(consesusm))
scoresu.grn.late <- pscores(adjm, list(consesusu))
scoresnet.grn.late <- pscores(adjm, list(consesunet))

scores.grn.late$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores vote")

scoresu.grn.late$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores union")

scoresnet.grn.late$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores INet")


```

```{r GRNBoost2 compare late, fig.width=8,fig.width=10}
ajm_compared <- compare_consensus(consesusm, adjm)
ajm_compared <- compare_consensus(consesusu, adjm)
ajm_compared <- compare_consensus(consesunet, adjm)

```

### ZILGM Park

```{r ZILGM late}
set.seed(1234)
time[["ZILGM_late_15Cores"]] <- system.time(
  zilgm_late <- infer_networks(count_matrices_list = count_matrices, method = "ZILGM", adjm = adjm, nCores = 15)
)

saveRDS(zilgm_late, "./../analysis/zilgm_late.RDS")

est_graphs <- zilgm_late$network_results
lambdas <- zilgm_late$lambda_results
```

```{r plotROC changing lambda}
plotROC(lambdas[[1]], adjm, plot_title = "Lambda ROC Matrix1", is_binary = T)
plotROC(lambdas[[2]], adjm, plot_title = "Lambda ROC Matrix2", is_binary = T)
plotROC(lambdas[[3]], adjm, plot_title = "Lambda ROC Matrix3", is_binary = T)
```




```{r ZILGM scores consensus lambda, fig.show='hide'}
consensus_matrices <- vector("list", 50)

for (i in 1:50) {
  ranklambda <- list(lambdas[[1]][[i]], lambdas[[2]][[i]], lambdas[[3]][[i]])
  consensus_matrices[[i]] <- create_consensus(ranklambda, method="vote")
}

zilgm_late_auc <- plotROC(consensus_matrices, adjm, plot_title = "ROC voting lambda", is_binary = T)
```


#### Comparison with the Ground Truth

```{r ZILGM scores late}
scores.zilgm.late.all <- pscores(adjm, est_graphs)

scores.zilgm.late.all$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores")
```



```{r ZILGM late plot graph}
plots <- plotg(est_graphs)
```

```{r ZILGM scores consensus}
consesusm <- create_consensus(est_graphs, method="vote")
consesusu <- create_consensus(est_graphs, method="union")

scores.zilgm.late <- pscores(adjm, list(consesusm))
scoresu.zilgm.late <- pscores(adjm, list(consesusu))

scores.zilgm.late$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores")
scoresu.zilgm.late$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores")
```


```{r ZILGM compare late, fig.width=8,fig.width=10}
ajm_compared <- compare_consensus(consesusm, adjm)
ajm_compared <- compare_consensus(consesusu, adjm)
```

### PCzinb

```{r}
#tictoc::tic("PCzinb late")
#zinbres <- infer_networks(count_matrices_list = count_matrices, 
#                          method = "PCzinb",
#                          adjm = adjm)
#execution_times[['PCzinb late']] <- tictoc::toc(log = TRUE)$toc[[1]]
```

```{r}
#consesusm <- create_consensus(zinbres, method="vote")
#consesusu <- create_consensus(zinbres, method="union")

#scores.pc.late <- pscores(adjm, list(consesusm))
#scoresu.pc.late <- pscores(adjm, list(consesusu))

#scores.pc.late$Statistics %>%
#    datatable(extensions = 'Buttons',
#              options = list(
#                dom = 'Bfrtip',
#                buttons = c('csv', 'excel'),
#                scrollX = TRUE,
#                pageLength = 10), 
#              caption = "scores vote")

#scoresu.pc.late$Statistics %>%
#    datatable(extensions = 'Buttons',
#              options = list(
#                dom = 'Bfrtip',
#                buttons = c('csv', 'excel'),
#                scrollX = TRUE,
#                pageLength = 10), 
#              caption = "scores union")
```


```{r}
#ajm_compared <- compare_consensus(consesusm, adjm)
#ajm_compared <- compare_consensus(consesusu, adjm)
```

## Early Integration

```{r earlym}
early_matrix <- list(earlyj(count_matrices))
```

### GENIE3

```{r run GENIE3 early}
set.seed(1234)
time[["GENIE3_early_15Cores"]] <- system.time(
  genie3_early <- infer_networks(early_matrix, method="GENIE3", nCores = 15)
)

saveRDS(genie3_early, "./../analysis/genie3_early.RDS")

genie3_early[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 output")
```

#### symmetrize Output and ROC

```{r GENIE3 symmetrizeROC early}
genie3_early_wadj <- generate_adjacency(genie3_early, ground.truth = adjm)
sgenie3_early_wadj <- symmetrize(genie3_early_wadj, weight_function = "mean")
genie3_early_auc <- plotROC(sgenie3_early_wadj, adjm, plot_title = "ROC curve - GENIE3 Early Integration")

sgenie3_early_wadj[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 symmetrize output")
```

#### Generate Adjacency and Apply Cutoff

```{r GENIE3 cutoff early}
sgenie3_early_adj <- cutoff_adjacency(count_matrices = early_matrix,
                 weighted_adjm_list = sgenie3_early_wadj, 
                 ground.truth = adjm,
                 n = 2,
                 method = "GENIE3",
                 nCores = 15)

sgenie3_early_adj[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 adjacency")

```

#### Comparison with the Ground Truth

```{r GENIE3 metrics early}
scores.genie3.early <- pscores(adjm, sgenie3_early_adj)

scores.genie3.early$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores")
```

```{r GENIE3 plotg early}
plots <- plotg(sgenie3_early_adj)
```

```{r GENIE3 compare early, fig.width=8,fig.width=10}
ajm_compared <- compare_consensus(sgenie3_early_adj[[1]], adjm)
```

### GRNBoost2

```{r GRNBoost2 early}
set.seed(1234)
start_time <- Sys.time()
time[["GRNBoost2_early"]] <- system.time(
  grnb_early <- infer_networks(early_matrix, method="GRNBoost2")
)

saveRDS(grnb_early, "./../analysis/grnb_early.RDS")

grnb_early[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 output")
```

#### symmetrize Output and ROC

```{r GRNBoost2 symmetrizeROC early}
grnb_early_wadj <- generate_adjacency(grnb_early, ground.truth = adjm)
sgrnb_early_wadj <- symmetrize(grnb_early_wadj, weight_function = "mean")
grnb_early_auc <- plotROC(sgrnb_early_wadj, adjm, plot_title = "ROC curve - GRNBoost2 Early Integration")

grnb_early_wadj[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 symmetrize output")
```

#### Generate Adjacency and Apply Cutoff

```{r GRNBoost2 cutoff early}
sgrnb_early_adj <- cutoff_adjacency(count_matrices = early_matrix,
                 weighted_adjm_list = sgrnb_early_wadj, 
                 ground.truth = adjm,
                 n = 2,
                 method = "GRNBoost2")

sgrnb_early_adj[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 adjacency")

```

#### Comparison with the Ground Truth

```{r GRNBoost2 metrics early}
scores.grn.early <- pscores(adjm, sgrnb_early_adj)

scores.grn.early$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores")
```

```{r GRNBoost2 plotg early}
plots <- plotg(sgrnb_early_adj)
```

```{r GRNBoost2 compare early, fig.width=8,fig.width=10}
ajm_compared <- compare_consensus(sgrnb_early_adj[[1]], adjm)
```

### ZILGM Park

```{r ZILGM early}
set.seed(1234)

time[["ZILGM_early_15Cores"]] <- system.time(
  zilgm_late <- infer_networks(count_matrices_list = early_matrix, method = "ZILGM", adjm = adjm, nCores = 15)
)

saveRDS(zilgm_late, "./../analysis/zilgm_early.RDS")

est_graphs <- zilgm_late$network_results
lambdas <- zilgm_late$lambda_results
```

```{r}
zilgm_early_auc <- plotROC(lambdas[[1]], adjm, plot_title = "ROC ZILGM early", is_binary = T)
```

#### Comparison with the Ground Truth

```{r ZIGLM score early}
scores.zilgm.early <- pscores(adjm, est_graphs)

scores.zilgm.early$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores")

```

```{r ZILGM compare early, fig.width=8,fig.width=10}
ajm_compared <- compare_consensus(est_graphs[[1]], adjm)
```

### PCzinb

```{r}
#tictoc::tic("PCzinb early")
#zinbres <- infer_networks(count_matrices_list = early_matrix, 
#                          method = "PCzinb",
#                          adjm = adjm)
#execution_times[['PCzinb early']] <- tictoc::toc(log = TRUE)$toc[[1]]
```

```{r}
#scores.pc.early <- pscores(adjm, zinbres)

#scores.pc.early$Statistics %>%
#    datatable(extensions = 'Buttons',
#              options = list(
#               dom = 'Bfrtip',
#                buttons = c('csv', 'excel'),
#                scrollX = TRUE,
#                pageLength = 10), 
#             caption = "scores early")
```


```{r}
#ajm_compared <- compare_consensus(zinbres[[1]], adjm)
```

## Joint Integration

### Joint Random Forest

```{r JRF inference}
#https://cran.r-project.org/src/contrib/Archive/JRF/
#install.packages("/home/francescoc/Downloads/JRF_0.1-4.tar.gz", repos = NULL, type = "source")
set.seed(1234)
time[["JRF"]] <- system.time(
  jrf_mat <- infer_networks(count_matrices, method="JRF")
)
 
jrf_mat[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "JRF output")

```

#### Their Permutation

```{r}
#jrf_matrices <- lapply(count_matrices, t)
#jrf_matrices_norm <- lapply(jrf_matrices,function(x) {
#  (x - mean(x)) / sd(x)
#  })

#genes <- rownames(jrf_matrices_norm[[1]])

#set.seed(1234)
#out.perm <- Run_permutation(jrf_matrices_norm,mtry=round(sqrt(length(genes)-1)),ntree=500, genes,5)

#myJRF_network <- function(out.jrf, out.perm, TH) {
  
#  nclasses <- dim(out.perm)[3]
#  M <- dim(out.perm)[2]
#  out <- vector("list", nclasses)  

#  for (net in 1:nclasses) { 
#    j.np <- sort(out.jrf[, 2 + net], decreasing = TRUE)
#    FDR <- matrix(0, dim(out.perm)[1], 1)
    
#    th <- NULL  
#    for (s in 1:length(j.np)) { 
#      FP <- sum(sum(out.perm[, , net] >= j.np[s])) / M
#      FDR[s] <- FP / s
      
#      if (FDR[s] > TH) {
#        th <- j.np[s]
#        break
#      }
#    }
    
#    out[[net]] <- out.jrf[out.jrf[, 2 + net] > th, seq(1, 2)]
#  }
  
#  return(out)
#}

#mynet <- myJRF_network(jrf_mat[[1]],out.perm,0.05)
#mynet

```


```{r}
#jrf_adj <- function(df_list, adjm) {
  # Ensure the genes (row and column names) are in the adjacency matrix
#  genes <- rownames(adjm)
  
  # Initialize a list to store adjacency matrices
#  adjacency_matrices <- list()
  
  # Loop through each data frame in the list
#  for (i in seq_along(df_list)) {
#    df <- df_list[[i]]
    
    # Initialize a new adjacency matrix with zeros
#    adj_matrix <- adjm * 0  # Reset to zero for each df
    
    # Update the adjacency matrix for the gene pairs
#    for (j in seq_len(nrow(df))) {
#      gene1 <- df$gene1[j]
#      gene2 <- df$gene2[j]
      
      # Check if both genes are present in the adjacency matrix
#      if (gene1 %in% genes && gene2 %in% genes) {
#        idx1 <- which(genes == gene1)  # Find the row index for gene1
#        idx2 <- which(genes == gene2)  # Find the column index for gene2
        
        # Update the adjacency matrix to set an edge
#        adj_matrix[idx1, idx2] <- 1
#        adj_matrix[idx2, idx1] <- 1  # Ensure symmetry
#      } else {
#        warning(paste("Gene pair not found in adjm:", gene1, "-", gene2))
#      }
#    }
    
    # Store the resulting adjacency matrix in the list
#    adjacency_matrices[[i]] <- adj_matrix
#  }
  
  # Return the list of adjacency matrices
#  return(adjacency_matrices)
#}


#jrf_adj_mynet <- jrf_adj(mynet, adjm)

```

```{r}
#jrf_auc_perm <- plotROC(jrf_adj_mynet, adjm, plot_title = "ROC curve - JRF perm out", is_binary = T)
```

```{r JRF perm scores}
#scores.jrf.perm <- pscores(adjm, jrf_adj_mynet)

#scores.jrf.perm$Statistics %>%
#    datatable(extensions = 'Buttons',
#              options = list(
#                dom = 'Bfrtip',
#                buttons = c('csv', 'excel'),
#                scrollX = TRUE,
#                pageLength = 10), 
#              caption = "scores")
```

```{r JRF perm plotg}
#plots <- plotg(jrf_adj_mynet)
```

```{r JRF consensus and score their perm}
#consesusu <- create_consensus(jrf_adj_mynet, method="union")

#scoresu.jrf.perm <- pscores(adjm, list(consesusu))

#scoresu.jrf.perm$Statistics %>%
#    datatable(extensions = 'Buttons',
#              options = list(
#                dom = 'Bfrtip',
#                buttons = c('csv', 'excel'),
#                scrollX = TRUE,
#                pageLength = 10), 
#              caption = "scores")

```

```{r JRF compare their perm, fig.width=8,fig.width=10}
#ajm_compared <- compare_consensus(consesusu, adjm)
```

#### Prepare the output

```{r}
jrf_list <- list()

importance_columns <- grep("importance", names(jrf_mat[[1]]), value = TRUE)

for (i in seq_along(importance_columns)) {
# Select the 'gene1', 'gene2', and the current 'importance' column
  df <- jrf_mat[[1]][, c("gene1", "gene2", importance_columns[i])]
  
  # Rename the importance column to its original name (e.g., importance1, importance2, etc.)
  names(df)[3] <- importance_columns[i]
  
  # Add the data frame to the output list
  jrf_list[[i]] <- df
}

saveRDS(jrf_list, "./../analysis/jrf.RDS")

jrf_list[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "JRF output")
```

#### symmetrize Output and ROC

```{r JRF symmetrizeROC late}
jrf_wadj <- generate_adjacency(jrf_list, ground.truth = adjm)
sjrf_wadj <- symmetrize(jrf_wadj, weight_function = "mean")
jrf_auc_mine <- plotROC(sjrf_wadj, adjm, plot_title = "ROC curve - JRF Late Integration")

sjrf_wadj[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "JRF symmetrize output")
```

#### Generate Adjacency and Apply Cutoff

```{r JRF cutoff late}
sjrf_adj <- cutoff_adjacency(count_matrices = count_matrices,
                 weighted_adjm_list = sjrf_wadj, 
                 ground.truth = adjm,
                 n = 3,
                 method = "JRF")

sjrf_adj[[1]] %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "JRF adjacency")

```

#### Comparison with the Ground Truth

```{r JRF metrics late}
scores.jrf.all <- pscores(adjm, sjrf_adj)

scores.jrf.all$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores")
```

```{r JRF plotg late}
plots <- plotg(sjrf_adj)
```

```{r JRF consensus and score late}
consesusm <- create_consensus(sjrf_adj, method="vote")
consesusu <- create_consensus(sjrf_adj, method="union")
consesunet <- create_consensus(adj_matrix_list = sjrf_adj, weighted_list = sjrf_wadj, method = "INet", threshold = 0.1, ncores = 15)

scores.jrf <- pscores(adjm, list(consesusm))
scoresu.jrf <- pscores(adjm, list(consesusu))
scoresnet.jrf <- pscores(adjm, list(consesunet))

scores.jrf$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores vote")

scoresu.jrf$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores union")

scoresnet.jrf$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores INet")

```

```{r JRF compare late, fig.width=8,fig.width=10}
ajm_compared <- compare_consensus(consesusm, adjm)
ajm_compared <- compare_consensus(consesusu, adjm)
ajm_compared <- compare_consensus(consesunet, adjm)
```


# Method Comparison

```{r, fig.height=10, fig.width=5}

time_data <- data.frame(
  Method = names(time),
  Time_in_Seconds = sapply(time, function(x) {
    if ("elapsed" %in% names(x)) x["elapsed"] else NA
  })
)

time_data$Time_in_Minutes <- as.numeric(time_data$Time_in_Seconds) / 60
time_data$Time_in_Hours <- as.numeric(time_data$Time_in_Seconds) / 3600

time_data <- time_data[order(time_data$Time_in_Hours), ]
time_data$Method <- factor(time_data$Method, levels = time_data$Method)

time_data <- time_data %>%
  mutate(Method_Group = case_when(
    grepl("GENIE3", Method) ~ "GENIE3",
    grepl("GRNBoost2", Method) ~ "GRNBoost2",
    grepl("ZILGM", Method) ~ "ZILGM",
    grepl("JRF", Method) ~ "JRF",
    grepl("PCzinb", Method) ~ "PCzinb"
  ))

method_colors <- c("GENIE3" = "darkblue", "GRNBoost2" = "darkgreen", "ZILGM" = "orange", "JRF" = "red", "PCzinb" = "purple")

time_plot <- ggplot(time_data, aes(x = Method, y = Time_in_Hours, fill = Method_Group)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = sprintf("%.1f min", Time_in_Minutes)), vjust = -0.5) +
  labs(title = "Execution Time for Each Method", y = "Time (Hours)", x = NULL) +
  scale_fill_manual(values = method_colors) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )

print(time_plot) 

```


```{r, fig.height=7, fig.width=5}
mplot <- list()

for (k in c("TPR", "FPR", "Precision", "F1", "Accuracy")) {
  mplot[[k]] <- data.frame(
    GENIE3_late = scores.genie3.late$Statistics[[k]],
    GENIE3_early = scores.genie3.early$Statistics[[k]],
    GRNBoost2_late = scores.grn.late$Statistics[[k]],
    GRNBoost2_early = scores.grn.early$Statistics[[k]],
    ZILGM_late = scores.zilgm.late$Statistics[[k]],
    ZILGM_early = scores.zilgm.early$Statistics[[k]],
    #PCzinb_late = scores.pc.late$Statistics[[k]],
    #PCzinb_early = scores.pc.early$Statistics[[k]],
    JRF = scores.jrf$Statistics[[k]]
  )
}

mplot[["AUC"]] <- data.frame(
    GENIE3_late = mean(genie3_late_auc$AUC),
    GENIE3_early = genie3_early_auc$AUC,
    GRNBoost2_late = mean(grnb_late_auc$AUC),
    GRNBoost2_early = grnb_early_auc$AUC,
    ZILGM_late = zilgm_late_auc$AUC,
    ZILGM_early = zilgm_early_auc$AUC,
    JRF = jrf_auc_mine$AUC
)

plot_data <- bind_rows(lapply(names(mplot), function(metric) {
  data.frame(
    Metric = metric,
    Method = names(mplot[[metric]]),
    Value = as.numeric(mplot[[metric]][1, ])
  )
}))

plot_data <- plot_data %>%
  mutate(Method_Group = case_when(
    grepl("GENIE3", Method) ~ "GENIE3",
    grepl("GRNBoost2", Method) ~ "GRNBoost2",
    grepl("ZILGM", Method) ~ "ZILGM",
    grepl("JRF", Method) ~ "JRF"
  )) %>%
  mutate(Method = factor(Method, levels = c(
    "GENIE3_early", "GENIE3_late", 
    "GRNBoost2_early", "GRNBoost2_late", 
    "ZILGM_early", "ZILGM_late","PCzinb_early", "PCzinb_late", 
    "JRF"  # Ensure JRF is last
  )))

plots <- lapply(unique(plot_data$Metric), function(metric) {
  show_x_text <- metric %in% c("Accuracy", "AUC")
  
  ggplot(plot_data %>% filter(Metric == metric), aes(x = Method, y = Value, fill = Method_Group)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
    labs(title = metric, y = "Value", x = NULL) +
    scale_y_continuous(limits = c(0, 1)) +  
    scale_fill_manual(values = method_colors) +
    theme_minimal() +
    theme(
      axis.text.x = if (show_x_text) element_text(angle = 45, hjust = 1) else element_blank(),
      axis.title.x = element_blank(),
      legend.position = "none"  
    )
})

final_plot <- (plots[[1]] | plots[[2]]) /
              (plots[[3]] | plots[[4]]) /
              (plots[[5]] | plots[[6]]) +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")

print(final_plot)
```


```{r}
sessionInfo()
```
