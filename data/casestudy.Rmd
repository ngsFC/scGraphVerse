---
title: "PBMC analysis"
author: "Francesco Cecere"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    theme: cerulean
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r}
knitr::opts_knit$set(root.dir = "/home/francescoc/Desktop/scGraphVerse/data/",message=FALSE, warning=FALSE)
```

## Load Libraries and data

```{r}
library(RColorBrewer)
library(DT)
library(tidyverse)
library(Seurat)
library(STRINGdb)
library(SingleCellExperiment)
library(scGraphVerse)
library(BiocParallel)
library(GENIE3)
library(patchwork)
reticulate::use_python("/usr/bin/python3", required = TRUE)
arboreto <- reticulate::import("arboreto.algo")
pandas <- reticulate::import("pandas")
numpy <- reticulate::import("numpy")

time <- list()

seurat_subset_filt <- readRDS("./../data/PBMC.top1200.RDS")
```

```{r}
seurat_split <- SplitObject(
  object = seurat_subset_filt,
  split.by = "donor_id"
)

seurat_split <- list("NP18"=as.matrix(seurat_split[[1]]@assays$RNA@data),
                     "AN8"=as.matrix(seurat_split[[2]]@assays$RNA@data),
                     "AN6"=as.matrix(seurat_split[[3]]@assays$RNA@data))
```

## GENIE3

### Late integration

```{r}
#sc_split <- lapply(seurat_split, as.SingleCellExperiment)

set.seed(1234)
time[["GENIE3_late_15Cores"]] <- system.time(
  genie3_late <- infer_networks(seurat_split, 
                                method="GENIE3",
                                nCores = 15)
)

genie3_late[[1]] %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 output")
```

#### Symmetrize and ROC

```{r}
genie3_late_wadj <- generate_adjacency(genie3_late)
sgenie3_late_wadj <- symmetrize(genie3_late_wadj, weight_function = "mean")

as.data.frame(sgenie3_late_wadj[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 symmetric weighted adjacency")

```

#### Cutoff

```{r}
sgenie3_late_adj <- cutoff_adjacency(count_matrices = seurat_split,
                                     weighted_adjm_list = sgenie3_late_wadj, 
                                     n = 3,
                                     method = "GENIE3",
                                     nCores = 15)

as.data.frame(sgenie3_late_adj[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 symmetric adjacency")
```


```{r, fig.width=10,fig.width=15}
plotg(sgenie3_late_adj)
```

#### Consensus

```{r}
consesusm <- create_consensus(sgenie3_late_adj, method="vote")
consesusu <- create_consensus(sgenie3_late_adj, method="union")
consesunet <- create_consensus(adj_matrix_list = sgenie3_late_adj, weighted_list = sgenie3_late_wadj, method = "INet", threshold = 0.05, ncores = 15)
```


```{r, fig.width=10,fig.width=15}
plotg(list(consesusm))
plotg(list(consesusu))
plotg(list(consesunet))
```

#### Plot comparison

```{r, fig.width=8,fig.width=10}
#adj <- stringdb_adjacency(
#  genes          = rownames(sgenie3_late_adj[[1]]),
#  species        = 9606,
#  required_score = 900,
#  keep_all_genes = T
#)

#adj <- adj$binary
#adj <- adj[rownames(consesusm),rownames(consesusm)]
#adj <- symmetrize(list(adj), weight_function = "mean")
#adj <- adj[[1]]

#plotg(list(adj))

compare_consensus(consensus_matrix = consesusm, false_plot = T)
compare_consensus(consensus_matrix = consesusu, false_plot = T)
compare_consensus(consensus_matrix = consesunet, false_plot = T)

```

#### PubMed Query

```{r}
query <- edge_mining(list(consesusm), adj, query_edge_types = "TP")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "TP PubMed query")

query <- edge_mining(list(consesusm), adj, query_edge_types = "FP")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "FP PubMed query")

query <- edge_mining(list(consesusm), adj, query_edge_types = "FN")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "FN PubMed query")
```

### Early integration

```{r}
early_matrix <- earlyj(seurat_split)

set.seed(1234)
time[["GENIE3_early_15Cores"]] <- system.time(
  genie3_early <- infer_networks(list(early_matrix), method="GENIE3", nCores = 15)
)

as.data.frame(genie3_early[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 early output")

```

#### Symmetrize and ROC

```{r}
genie3_early_wadj <- generate_adjacency(genie3_early)
sgenie3_early_wadj <- symmetrize(genie3_early_wadj, weight_function = "mean")

as.data.frame(sgenie3_early_wadj[[1]]) %>%
  slice_head(n=30) %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 early symmetric weighted adjacency")

```

#### Cutoff

```{r}
sgenie3_early_adj <- cutoff_adjacency(count_matrices = list(early_matrix),
                                      weighted_adjm_list = sgenie3_early_wadj, 
                                      n = 2,
                                      method = "GENIE3",
                                      nCores = 15)

as.data.frame(sgenie3_early_adj[[1]]) %>%
  slice_head(n=30) %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 early symmetric adjacency")

```


```{r, fig.width=10,fig.width=15}
plotg(sgenie3_early_adj)
```


#### Plot comparison

```{r, fig.width=8,fig.width=10}
#adj <- stringdb_adjacency(
#  genes          = rownames(sgenie3_early_adj[[1]]),
#  species        = 9606,
#  required_score = 900,
#  keep_all_genes = T
#)

#adj <- adj$binary
#adj <- adj[rownames(sgenie3_early_adj[[1]]),rownames(sgenie3_early_adj[[1]])]
#adj <- symmetrize(list(adj), weight_function = "mean")
#adj <- adj[[1]]

#plotg(list(adj))

compare_consensus(consensus_matrix = sgenie3_early_adj[[1]], false_plot = T)
```

#### PubMed Query

```{r}
query <- edge_mining(sgenie3_early_adj, adj, query_edge_types = "TP")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "TP PubMed query")

query <- edge_mining(sgenie3_early_adj, adj, query_edge_types = "FP")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "FP PubMed query")

query <- edge_mining(sgenie3_early_adj, adj, query_edge_types = "FN")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "FN PubMed query")
```

## GRNBoost2

### Late integration

```{r}
set.seed(1234)
time[["grnboost_late"]] <- system.time(
  grnboost_late <- infer_networks(seurat_split, 
                                method="GRNBoost2",
                                nCores = 15)
)

as.data.frame(grnboost_late[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 late output")

```

#### Symmetrize and ROC

```{r}
grnboost_late_wadj <- generate_adjacency(grnboost_late)
sgrnboost_late_wadj <- symmetrize(grnboost_late_wadj, weight_function = "mean")

as.data.frame(sgrnboost_late_wadj[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 symmetric weighted adjacency")

```

#### Cutoff

```{r}
sgrnboost_late_adj <- cutoff_adjacency(count_matrices = seurat_split,
                                     weighted_adjm_list = sgrnboost_late_wadj, 
                                     n = 3,
                                     method = "GRNBoost2",
                                     nCores = 15)

as.data.frame(sgrnboost_late_adj[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 symmetric adjacency")
```


```{r, fig.width=10,fig.width=15}
plots <- plotg(sgrnboost_late_adj)
```

#### Consensus

```{r}
consesusm <- create_consensus(sgrnboost_late_adj, method="vote")
consesusu <- create_consensus(sgrnboost_late_adj, method="union")
consesunet <- create_consensus(adj_matrix_list = sgrnboost_late_adj, weighted_list = sgrnboost_late_wadj, method = "INet", threshold = 0.05)
```

#### Plot comparison

```{r, fig.width=8,fig.width=10}
#adj <- stringdb_adjacency(
#  genes          = rownames(sgrnboost_late_adj[[1]]),
#  species        = 9606,
#  required_score = 900,
#  keep_all_genes = T
#)

#adj <- adj$binary
#adj <- adj[rownames(consesusm),rownames(consesusm)]
#adj <- symmetrize(list(adj), weight_function = "mean")
#adj <- adj[[1]]

#plotg(list(adj))

compare_consensus(consensus_matrix = consesusm, false_plot = T)
compare_consensus(consensus_matrix = consesusu, false_plot = T)
compare_consensus(consensus_matrix = consesunet, false_plot = T)

```

#### PubMed Query

```{r}
query <- edge_mining(list(consesusm), adj, query_edge_types = "TP")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "TP PubMed query")

query <- edge_mining(list(consesusm), adj, query_edge_types = "FP")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "FP PubMed query")

query <- edge_mining(list(consesusm), adj, query_edge_types = "FN")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "FN PubMed query")
```

### Early integration

```{r}
early_matrix <- earlyj(seurat_split)

set.seed(1234)
time[["grnboost_early"]] <- system.time(
  grnboost_early <- infer_networks(list(early_matrix), method="GRNBoost2")
)

as.data.frame(grnboost_early[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 early output")
```

#### Symmetrize and ROC

```{r}
grnboost_early_wadj <- generate_adjacency(grnboost_early)
sgrnboost_early_wadj <- symmetrize(grnboost_early_wadj, weight_function = "mean")

as.data.frame(sgrnboost_early_wadj[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 symmetric weighted adjacency")

```

#### Cutoff

```{r}
sgrnboost_early_adj <- cutoff_adjacency(count_matrices = list(early_matrix),
                                      weighted_adjm_list = sgrnboost_early_wadj, 
                                      n = 2,
                                      method = "GRNBoost2",
                                      nCores = 15)

as.data.frame(sgrnboost_early_adj[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 symmetric adjacency")

```


```{r, fig.width=10,fig.width=15}
plots <- plotg(sgrnboost_early_adj)

```

#### Plot comparison

```{r, fig.width=8,fig.width=8}
compare_consensus(consensus_matrix = sgrnboost_early_adj[[1]], false_plot = T)
```

#### PubMed Query

```{r}
query <- edge_mining(sgrnboost_early_adj, adj, query_edge_types = "TP")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "TP PubMed query")

query <- edge_mining(sgrnboost_early_adj, adj, query_edge_types = "FP")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "FP PubMed query")

query <- edge_mining(sgrnboost_early_adj, adj, query_edge_types = "FN")

query[[1]] %>%
    datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "FN PubMed query")

```


