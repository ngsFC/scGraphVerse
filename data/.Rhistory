ggtitle("n=100 k=3") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
plot_final <- plot_base + facet_wrap(~Metric, scales = "free", ncol = 3)
print(plot_final)
knitr::opts_knit$set(root.dir = "/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results",message=FALSE, warning=FALSE)
library(dplyr)
library(purrr)
library(patchwork)
library(tidyr)
library(ggplot2)
met_files <- c("/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp100_10runs.txt",
"/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp200_10runs.txt",
"/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp500_10runs.txt")
read_and_fulljoin <- function(files) {
df_list <- lapply(files, read.table, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
full_joined_df <- Reduce(function(x, y) full_join(x, y), df_list)
return(full_joined_df)
}
met_data <- read_and_fulljoin(met_files)
met_late <- met_data %>%
mutate(Ratio = as.character(Ratio_mean),
p = as.character(p_mean)) %>%
filter(Predicted_Matrix %in% c("vote", "union", "inet")) %>%
filter(Method != "JRF")
met_late_long <- met_late %>%
pivot_longer(cols = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean"),
names_to = "Metric", values_to = "Value") %>%
mutate(Metric = factor(Metric, levels = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean")),
p = factor(p, levels = c("82", "217", "554")))
plot_base <- ggplot(met_late_long, aes(x = p, y = Value,
color = Method,
shape = Predicted_Matrix,
group = interaction(Method, Predicted_Matrix))) +
geom_line(size = 0.4, alpha=0.7) +  # Slightly increase line size and adjust transparency
geom_point(size = 2, alpha=0.8) +    # Increase point size for better visibility
labs(x = "Number of Genes (p)", y = "Performance", color = "Method", shape = "Late Strategy") +
theme_minimal() +
scale_color_manual("Methods", values = c("GENIE3"="purple4", "GRNBoost2"="forestgreen", "JRF"="darkorange")) +
ggtitle("n=100 k=3") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
plot_final <- plot_base + facet_wrap(~Metric, scales = "free", ncol = 3)
print(plot_final)
ggsave("./../analysis/simulation/plot/late_dots_n100.png", plot_final, width = 8, height = 5, dpi = 300, bg = "white")
met_comp <- met_data %>%
mutate(Ratio = as.character(Ratio_mean),
p = as.character(p_mean)) %>%
filter(!Predicted_Matrix %in% c("inet", "union")) %>%
mutate(
Predicted_Matrix = ifelse(Predicted_Matrix == "vote", "late", Predicted_Matrix),
Predicted_Matrix = ifelse(Method == "JRF", "joint", Predicted_Matrix)  # Replace JRF with joint
)
met_comp_long <- met_comp %>%
pivot_longer(cols = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean"),
names_to = "Metric", values_to = "Value") %>%
mutate(Metric = factor(Metric, levels = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean")),
p = factor(p, levels = c("82", "217", "554")))
plot_base <- ggplot(met_comp_long, aes(x = p, y = Value,
color = Method,
linetype = Predicted_Matrix,  # Change to linetype
group = interaction(Method, Predicted_Matrix))) +
geom_line(size = 0.7, alpha=0.8) +  # Increase line size for better visibility
geom_point(size = 1, alpha=0.8) +    # Increase point size for better visibility
labs(x = "Number of Genes (p)", y = "Performance", color = "Method", shape = "Late Strategy") +
theme_minimal() +
scale_color_manual("Methods", values = c("GENIE3"="purple4", "GRNBoost2"="forestgreen", "JRF"="darkorange")) +
scale_linetype_manual("Integration", values = c("late"="dashed", "early"="dotted", "joint"="solid")) +  # Custom line types
ggtitle("n=100 k=3") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
plot_final <- plot_base + facet_wrap(~Metric, scales = "free", ncol = 3)
print(plot_final)
ggsave("./../analysis/simulation/plot/metrics_comp.png", plot_final, width = 8, height = 5, dpi = 300, bg = "white")
met_comp_long <- met_comp %>%
pivot_longer(cols = c("Modularity_mean", "Density_mean", "Transitivity_mean", "VI_mean", "NMI_mean", "ARI_mean"),
names_to = "Metric", values_to = "Value") %>%
mutate(Metric = factor(Metric, levels = c("Modularity_mean", "Density_mean", "Transitivity_mean", "VI_mean", "NMI_mean", "ARI_mean")),
p = factor(p, levels = c("82", "217", "554")))
plot_base <- ggplot(met_comp_long, aes(x = p, y = Value,
color = Method,
linetype = Predicted_Matrix,  # Change to linetype
group = interaction(Method, Predicted_Matrix))) +
geom_line(size = 0.7, alpha=0.8) +  # Increase line size for better visibility
geom_point(size = 1, alpha=0.8) +    # Increase point size for better visibility
labs(x = "Number of Genes (p)", y = "Performance", color = "Method", shape = "Late Strategy") +
theme_minimal() +
scale_color_manual("Methods", values = c("GENIE3"="purple4", "GRNBoost2"="forestgreen", "JRF"="darkorange")) +
scale_linetype_manual("Integration", values = c("late"="dashed", "early"="dotted", "joint"="solid")) +  # Custom line types
ggtitle("n=100 k=3") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
plot_final <- plot_base + facet_wrap(~Metric, scales = "free", ncol = 3)
print(plot_final)
ggsave("./../analysis/simulation/plot/metrics_graph_comp.png", plot_final, width = 8, height = 5, dpi = 300, bg = "white")
ls
met_files <- c("/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp100n500_10runs.txt",
"/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp200n500_10runs.txt",
"/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp500n500_10runs.txt")
read_and_fulljoin <- function(files) {
df_list <- lapply(files, read.table, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
full_joined_df <- Reduce(function(x, y) full_join(x, y), df_list)
return(full_joined_df)
}
met_data <- read_and_fulljoin(met_files)
met_late <- met_data %>%
mutate(Ratio = as.character(Ratio_mean),
p = as.character(p_mean)) %>%
filter(Predicted_Matrix %in% c("vote", "union", "inet")) %>%
filter(Method != "JRF")
met_late_long <- met_late %>%
pivot_longer(cols = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean"),
names_to = "Metric", values_to = "Value") %>%
mutate(Metric = factor(Metric, levels = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean")),
p = factor(p, levels = c("82", "217", "554")))
plot_base <- ggplot(met_late_long, aes(x = p, y = Value,
color = Method,
shape = Predicted_Matrix,
group = interaction(Method, Predicted_Matrix))) +
geom_line(size = 0.4, alpha=0.7) +  # Slightly increase line size and adjust transparency
geom_point(size = 2, alpha=0.8) +    # Increase point size for better visibility
labs(x = "Number of Genes (p)", y = "Performance", color = "Method", shape = "Late Strategy") +
theme_minimal() +
scale_color_manual("Methods", values = c("GENIE3"="purple4", "GRNBoost2"="forestgreen", "JRF"="darkorange")) +
ggtitle("n=500 k=3") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
plot_final <- plot_base + facet_wrap(~Metric, scales = "free", ncol = 3)
print(plot_final)
knitr::opts_knit$set(root.dir = "/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results",message=FALSE, warning=FALSE)
library(dplyr)
library(purrr)
library(patchwork)
library(tidyr)
library(ggplot2)
met_files <- c("/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp100_10runs.txt",
"/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp200_10runs.txt",
"/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp500_10runs.txt")
read_and_fulljoin <- function(files) {
df_list <- lapply(files, read.table, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
full_joined_df <- Reduce(function(x, y) full_join(x, y), df_list)
return(full_joined_df)
}
met_data <- read_and_fulljoin(met_files)
met_late <- met_data %>%
mutate(Ratio = as.character(Ratio_mean),
p = as.character(p_mean)) %>%
filter(Predicted_Matrix %in% c("vote", "union", "inet")) %>%
filter(Method != "JRF")
met_late_long <- met_late %>%
pivot_longer(cols = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean"),
names_to = "Metric", values_to = "Value") %>%
mutate(Metric = factor(Metric, levels = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean")),
p = factor(p, levels = c("82", "217", "554")))
plot_base <- ggplot(met_late_long, aes(x = p, y = Value,
color = Method,
shape = Predicted_Matrix,
group = interaction(Method, Predicted_Matrix))) +
geom_line(size = 0.4, alpha=0.7) +  # Slightly increase line size and adjust transparency
geom_point(size = 2, alpha=0.8) +    # Increase point size for better visibility
labs(x = "Number of Genes (p)", y = "Performance", color = "Method", shape = "Late Strategy") +
theme_minimal() +
scale_color_manual("Methods", values = c("GENIE3"="purple4", "GRNBoost2"="forestgreen", "JRF"="darkorange")) +
ggtitle("n=100 k=3") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
plot_final <- plot_base + facet_wrap(~Metric, scales = "free", ncol = 3)
print(plot_final)
ggsave("./../analysis/simulation/plot/late_dots_n100.png", plot_final, width = 8, height = 5, dpi = 300, bg = "white")
met_comp <- met_data %>%
mutate(Ratio = as.character(Ratio_mean),
p = as.character(p_mean)) %>%
filter(!Predicted_Matrix %in% c("inet", "union")) %>%
mutate(
Predicted_Matrix = ifelse(Predicted_Matrix == "vote", "late", Predicted_Matrix),
Predicted_Matrix = ifelse(Method == "JRF", "joint", Predicted_Matrix)  # Replace JRF with joint
)
met_comp_long <- met_comp %>%
pivot_longer(cols = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean"),
names_to = "Metric", values_to = "Value") %>%
mutate(Metric = factor(Metric, levels = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean")),
p = factor(p, levels = c("82", "217", "554")))
plot_base <- ggplot(met_comp_long, aes(x = p, y = Value,
color = Method,
linetype = Predicted_Matrix,  # Change to linetype
group = interaction(Method, Predicted_Matrix))) +
geom_line(size = 0.7, alpha=0.8) +  # Increase line size for better visibility
geom_point(size = 1, alpha=0.8) +    # Increase point size for better visibility
labs(x = "Number of Genes (p)", y = "Performance", color = "Method", shape = "Late Strategy") +
theme_minimal() +
scale_color_manual("Methods", values = c("GENIE3"="purple4", "GRNBoost2"="forestgreen", "JRF"="darkorange")) +
scale_linetype_manual("Integration", values = c("late"="dashed", "early"="dotted", "joint"="solid")) +  # Custom line types
ggtitle("n=100 k=3") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
plot_final <- plot_base + facet_wrap(~Metric, scales = "free", ncol = 3)
print(plot_final)
ggsave("./../analysis/simulation/plot/metrics_comp.png", plot_final, width = 8, height = 5, dpi = 300, bg = "white")
met_comp_long <- met_comp %>%
pivot_longer(cols = c("Modularity_mean", "Density_mean", "Transitivity_mean", "VI_mean", "NMI_mean", "ARI_mean"),
names_to = "Metric", values_to = "Value") %>%
mutate(Metric = factor(Metric, levels = c("Modularity_mean", "Density_mean", "Transitivity_mean", "VI_mean", "NMI_mean", "ARI_mean")),
p = factor(p, levels = c("82", "217", "554")))
plot_base <- ggplot(met_comp_long, aes(x = p, y = Value,
color = Method,
linetype = Predicted_Matrix,  # Change to linetype
group = interaction(Method, Predicted_Matrix))) +
geom_line(size = 0.7, alpha=0.8) +  # Increase line size for better visibility
geom_point(size = 1, alpha=0.8) +    # Increase point size for better visibility
labs(x = "Number of Genes (p)", y = "Performance", color = "Method", shape = "Late Strategy") +
theme_minimal() +
scale_color_manual("Methods", values = c("GENIE3"="purple4", "GRNBoost2"="forestgreen", "JRF"="darkorange")) +
scale_linetype_manual("Integration", values = c("late"="dashed", "early"="dotted", "joint"="solid")) +  # Custom line types
ggtitle("n=100 k=3") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
plot_final <- plot_base + facet_wrap(~Metric, scales = "free", ncol = 3)
print(plot_final)
ggsave("./../analysis/simulation/plot/metrics_graph_comp.png", plot_final, width = 8, height = 5, dpi = 300, bg = "white")
met_files <- c("/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp100n500_10runs.txt",
"/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp200n500_10runs.txt",
"/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/simp500n500_10runs.txt")
read_and_fulljoin <- function(files) {
df_list <- lapply(files, read.table, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
full_joined_df <- Reduce(function(x, y) full_join(x, y), df_list)
return(full_joined_df)
}
met_data <- read_and_fulljoin(met_files)
met_late <- met_data %>%
mutate(Ratio = as.character(Ratio_mean),
p = as.character(p_mean)) %>%
filter(Predicted_Matrix %in% c("vote", "union", "inet")) %>%
filter(Method != "JRF")
met_late_long <- met_late %>%
pivot_longer(cols = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean"),
names_to = "Metric", values_to = "Value") %>%
mutate(Metric = factor(Metric, levels = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean")),
p = factor(p, levels = c("82", "217", "554")))
plot_base <- ggplot(met_late_long, aes(x = p, y = Value,
color = Method,
shape = Predicted_Matrix,
group = interaction(Method, Predicted_Matrix))) +
geom_line(size = 0.4, alpha=0.7) +  # Slightly increase line size and adjust transparency
geom_point(size = 2, alpha=0.8) +    # Increase point size for better visibility
labs(x = "Number of Genes (p)", y = "Performance", color = "Method", shape = "Late Strategy") +
theme_minimal() +
scale_color_manual("Methods", values = c("GENIE3"="purple4", "GRNBoost2"="forestgreen", "JRF"="darkorange")) +
ggtitle("n=500 k=3") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
plot_final <- plot_base + facet_wrap(~Metric, scales = "free", ncol = 3)
print(plot_final)
ggsave("./../analysis/simulation/plot/late_dots_n500.png", plot_final, width = 8, height = 5, dpi = 300, bg = "white")
met_comp <- met_data %>%
mutate(Ratio = as.character(Ratio_mean),
p = as.character(p_mean)) %>%
filter(!Predicted_Matrix %in% c("inet", "union")) %>%
mutate(
Predicted_Matrix = ifelse(Predicted_Matrix == "vote", "late", Predicted_Matrix),
Predicted_Matrix = ifelse(Method == "JRF", "joint", Predicted_Matrix)  # Replace JRF with joint
)
met_comp_long <- met_comp %>%
pivot_longer(cols = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean"),
names_to = "Metric", values_to = "Value") %>%
mutate(Metric = factor(Metric, levels = c("TPR_mean", "FPR_mean", "Precision_mean", "F1_mean", "MCC_mean", "Time_in_Minutes_mean")),
p = factor(p, levels = c("82", "217", "554")))
plot_base <- ggplot(met_comp_long, aes(x = p, y = Value,
color = Method,
linetype = Predicted_Matrix,  # Change to linetype
group = interaction(Method, Predicted_Matrix))) +
geom_line(size = 0.7, alpha=0.8) +  # Increase line size for better visibility
geom_point(size = 1, alpha=0.8) +    # Increase point size for better visibility
labs(x = "Number of Genes (p)", y = "Performance", color = "Method", shape = "Late Strategy") +
theme_minimal() +
scale_color_manual("Methods", values = c("GENIE3"="purple4", "GRNBoost2"="forestgreen", "JRF"="darkorange")) +
scale_linetype_manual("Integration", values = c("late"="dashed", "early"="dotted", "joint"="solid")) +  # Custom line types
ggtitle("n=500 k=3") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
plot_final <- plot_base + facet_wrap(~Metric, scales = "free", ncol = 3)
print(plot_final)
ggsave("./../analysis/simulation/plot/metrics_comp_n500.png", plot_final, width = 8, height = 5, dpi = 300, bg = "white")
met_comp_long <- met_comp %>%
pivot_longer(cols = c("Modularity_mean", "Density_mean", "Transitivity_mean", "VI_mean", "NMI_mean", "ARI_mean"),
names_to = "Metric", values_to = "Value") %>%
mutate(Metric = factor(Metric, levels = c("Modularity_mean", "Density_mean", "Transitivity_mean", "VI_mean", "NMI_mean", "ARI_mean")),
p = factor(p, levels = c("82", "217", "554")))
plot_base <- ggplot(met_comp_long, aes(x = p, y = Value,
color = Method,
linetype = Predicted_Matrix,  # Change to linetype
group = interaction(Method, Predicted_Matrix))) +
geom_line(size = 0.7, alpha=0.8) +  # Increase line size for better visibility
geom_point(size = 1, alpha=0.8) +    # Increase point size for better visibility
labs(x = "Number of Genes (p)", y = "Performance", color = "Method", shape = "Late Strategy") +
theme_minimal() +
scale_color_manual("Methods", values = c("GENIE3"="purple4", "GRNBoost2"="forestgreen", "JRF"="darkorange")) +
scale_linetype_manual("Integration", values = c("late"="dashed", "early"="dotted", "joint"="solid")) +  # Custom line types
ggtitle("n=500 k=3") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
plot_final <- plot_base + facet_wrap(~Metric, scales = "free", ncol = 3)
print(plot_final)
ggsave("./../analysis/simulation/plot/metrics_graph_comp_n500.png", plot_final, width = 8, height = 5, dpi = 300, bg = "white")
library(scGraphVerse)
remove.packages("scGraphVerse")
.rs.restartR()
Sys.setenv(GITHUB_PAT = "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")
devtools::install_github("ngsFC/scGraphVerse", force = T)
library(scGraphVerse)
View()
View(infer_networks())
View(infer_networks)
View(cutoff_adjacency())
View(cutoff_adjacency)
setwd("/home/francescoc/Desktop/scGraphVerse/data/")
ddir <- "/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/"
pdir <- "/home/francescoc/Desktop/scGraphVerse/analysis/simulation/plot/"
library(tidyverse)
library(scGraphVerse)
modules <- init_py(python_path ="/usr/bin/python3", required = TRUE)
time <- list()
ddir <- "/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/"
pdir <- "/home/francescoc/Desktop/scGraphVerse/analysis/simulation/plot/"
adjm <- as.matrix(read.table("./../analysis/simulation/adjacency/adjm_top200_p100.txt"))
colnames(adjm) <- rownames(adjm)
count_matrices <- readRDS("./../analysis/simulation/simdata/sim_n100p100.RDS")
count_matrices <- lapply(count_matrices, t)
seed_base <- 1234
run_id <- 1
# GRNBoost2
## Late integration
time[["GRNBoost2_late"]] <- system.time(
late <- infer_networks(count_matrices,
method="GRNBoost2",
grnboost_modules = modules,
seed=seed_base+run_id)
)
late_wadj <- generate_adjacency(late)
slate_wadj <- symmetrize(late_wadj, weight_function = "mean")
late_auc <- plotROC(slate_wadj, adjm, plot_title = "ROC curve - grnboost Late Integration")
slate_adj <- cutoff_adjacency(count_matrices = count_matrices,
weighted_adjm_list = slate_wadj,
n = 3,
method = "GRNBoost2",
grnboost_modules = modules)
#' @param count_matrices_list A list of expression matrices (genes × cells) or Seurat / SingleCellExperiment objects.
#' @param method Character. One of: "GENIE3", "GRNBoost2", "ZILGM", "JRF", "PCzinb".
#' @param adjm Optional adjacency matrix (used to rename output matrices).
#' @param nCores Number of CPU cores to use for parallel computation.
#' @param grnboost_modules Python modules list returned by `init_py()`, required for GRNBoost2.
#'
#' @return A list of inferred networks (format varies by method).
#'
#' @importFrom BiocParallel bplapply bpworkers bpparam MulticoreParam
#' @export
infer_networks <- function(count_matrices_list,
method = "GENIE3",
adjm = NULL,
nCores = BiocParallel::bpworkers(BiocParallel::bpparam()) - 1,
grnboost_modules = NULL,
seed = NULL) {
method <- match.arg(method, choices = c("GENIE3", "GRNBoost2", "ZILGM", "JRF", "PCzinb"))
if (!is.null(seed)) set.seed(seed)  # for GENIE3, GRNBoost2, ZILGM
# Normalize input matrices
count_matrices_list <- lapply(count_matrices_list, function(obj) {
if (inherits(obj, "Seurat")) {
expr <- Seurat::GetAssayData(obj, assay = "RNA", slot = "counts")
as.matrix(expr)
} else if (inherits(obj, "SingleCellExperiment")) {
expr <- SummarizedExperiment::assay(obj, "counts")
as.matrix(expr)
} else {
as.matrix(obj)
}
})
# --- GENIE3 ---
if (method == "GENIE3") {
return(lapply(count_matrices_list, function(mat) {
if (!is.null(seed)) set.seed(seed)
adj <- GENIE3::GENIE3(mat, nCores = nCores)
GENIE3::getLinkList(adj)
}))
}
# --- GRNBoost2 ---
if (method == "GRNBoost2") {
if (is.null(grnboost_modules)) {
stop("For method 'GRNBoost2', please provide Python modules via `init_py()`.")
}
return(lapply(seq_along(count_matrices_list), function(i) {
if (!is.null(seed)) set.seed(seed)
mat <- count_matrices_list[[i]]
df <- as.data.frame(t(mat))  # genes = cols, cells = rows
genes <- colnames(df)
rownames(df) <- make.unique(rownames(df))  # ensure unique cell names
# Create Pandas DataFrame
df_pandas <- grnboost_modules$pandas$DataFrame(
data = as.matrix(df),
columns = genes
)
# Run GRNBoost2
result_py <- grnboost_modules$arboreto$grnboost2(
expression_data = df_pandas,
gene_names = genes,
client_or_address = NULL
)
# Let reticulate handle the conversion automatically
result_r <- reticulate::py_to_r(result_py)
# Clean up any rownames warnings by removing them explicitly
if (is.data.frame(result_r)) {
rownames(result_r) <- NULL
}
return(result_r)
}))
}
# --- ZILGM ---
if (method == "ZILGM") {
zilgm_fits <- lapply(count_matrices_list, function(mat) {
if (!is.null(seed)) set.seed(seed)
gene_names <- rownames(mat)
lambda_max <- ZILGM::find_lammax(t(mat))
lambda_seq <- exp(seq(log(lambda_max), log(1e-4 * lambda_max), length.out = 50))
fit <- ZILGM::zilgm(
X = t(mat),
lambda = lambda_seq,
family = "NBII",
update_type = "IRLS",
do_boot = TRUE,
boot_num = 10,
sym = "OR",
nCores = nCores
)
list(fit = fit, genes = gene_names)
})
network_results <- lapply(zilgm_fits, function(result) {
mat <- result$fit$network[[result$fit$opt_index]]
rownames(mat) <- result$genes
colnames(mat) <- result$genes
if (!is.null(adjm)) {
rownames(mat) <- rownames(adjm)
colnames(mat) <- colnames(adjm)
}
mat
})
lambda_results <- lapply(zilgm_fits, function(result) {
nets <- lapply(result$fit$network, as.matrix)
names(nets) <- result$fit$lambda
for (i in seq_along(nets)) {
rownames(nets[[i]]) <- result$genes
colnames(nets[[i]]) <- result$genes
if (!is.null(adjm)) {
rownames(nets[[i]]) <- rownames(adjm)
colnames(nets[[i]]) <- colnames(adjm)
}
}
nets
})
return(list(
network_results = lapply(network_results, as.matrix),
lambda_results = lambda_results
))
}
# --- PCzinb ---
if (method == "PCzinb") {
pc_param <- if (!is.null(seed)) {
BiocParallel::MulticoreParam(workers = nCores, RNGseed = seed)
} else {
BiocParallel::MulticoreParam(workers = nCores)
}
return(BiocParallel::bplapply(count_matrices_list, function(mat) {
net <- learn2count::PCzinb(t(mat), method = "zinb1", maxcard = 2)
if (!is.null(adjm)) {
rownames(net) <- rownames(adjm)
colnames(net) <- colnames(adjm)
}
net
}, BPPARAM = pc_param))
}
# --- JRF ---
if (method == "JRF") {
jrf_param <- if (!is.null(seed)) {
BiocParallel::MulticoreParam(workers = nCores, RNGseed = seed)
} else {
BiocParallel::MulticoreParam(workers = nCores)
}
norm_list <- BiocParallel::bplapply(count_matrices_list, function(x) {
t(scale(t(x)))
}, BPPARAM = jrf_param)
rf <- JRF::JRF(
X = norm_list,
genes.name = rownames(norm_list[[1]]),
ntree = 500,
mtry = round(sqrt(nrow(norm_list[[1]]) - 1))
)
return(list(rf))
}
}
slate_adj <- cutoff_adjacency(count_matrices = count_matrices,
weighted_adjm_list = slate_wadj,
n = 3,
method = "GRNBoost2",
grnboost_modules = modules)
