---
title: "Simulations Inferred network and Performances"
author: "Francesco Cecere"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    theme: cerulean
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r}
knitr::opts_knit$set(root.dir = "/home/francescoc/Desktop/scGraphVerse/data/",message=FALSE, warning=FALSE)
```

# Load Libraries and data

```{r}
#library(RColorBrewer)
library(DT)
library(tidyverse)
#library(Seurat)
#library(STRINGdb)
#library(SingleCellExperiment)
library(scGraphVerse)
#library(BiocParallel)
#library(GENIE3)
#library(fmsb)

modules <- init_py(python_path ="/usr/bin/python3", required = TRUE )
time <- list()

ddir <- "/home/francescoc/Desktop/scGraphVerse/analysis/simulation/results/"
pdir <- "/home/francescoc/Desktop/scGraphVerse/analysis/simulation/plot/"

```

# Adjacency and Count matrices

```{r}
adjm <- as.matrix(read.table("./../analysis/simulation/adjacency/adjm_top1200_p500.txt"))
colnames(adjm) <- rownames(adjm)

as.data.frame(adjm) %>%
  datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "Ground Truth")

count_matrices <- readRDS("./../analysis/simulation/simdata/sim_n100p500k5.RDS")
dim(count_matrices[[1]])

count_matrices <- lapply(count_matrices, t)

as.data.frame(count_matrices[[1]]) %>%
  slice_head(n=10) %>%
  datatable(extensions = 'Buttons',
            options = list(
              dom = 'Bfrtip',
              buttons = c('csv', 'excel'),
              scrollX = TRUE,
              pageLength = 10), 
            caption = "Simulated Count matrix")

count_matrices <- count_matrices[1]
```


# GENIE3

## Late integration

```{r}
set.seed(1234)
time[["GENIE3_late_15Cores"]] <- system.time(
  late <- infer_networks(count_matrices, 
                         method="GENIE3",
                         nCores = 15)
  )

late[[1]] %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 output")
```

### Symmetrize and ROC

```{r}
late_wadj <- generate_adjacency(late)
slate_wadj <- symmetrize(late_wadj, weight_function = "mean")

as.data.frame(slate_wadj[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 symmetric weighted adjacency")
```


```{r}
late_auc <- plotROC(slate_wadj, adjm, plot_title = "ROC curve - GENIE3 Late Integration", is_binary = F)
```

### Cutoff

```{r}
slate_adj <- cutoff_adjacency(count_matrices = count_matrices,
                                     weighted_adjm_list = slate_wadj, 
                                     n = 3,
                                     method = "GENIE3",
                                     nCores = 15)

as.data.frame(slate_adj[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GENIE3 symmetric adjacency")
```


```{r}
scores.late.all <- pscores(adjm, slate_adj)
scores.late.all$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores late")

keepscores <- scores.late.all$Statistics %>% mutate(Predicted_Matrix=c("early"), Method=c("GENIE3"), Ratio=nrow(adjm)/ncol(count_matrices[[1]]), p=nrow(adjm), k=seq_along(count_matrices))

```


```{r, fig.width=10,fig.width=15}
plotg(slate_adj)
```


### Plot comparison

```{r, fig.width=8,fig.width=8}
compare_consensus(consensus_matrix = slate_adj[[1]], reference_matrix = adjm, false_plot = F)
```

### Community detection

```{r, fig.width=5, fig.height=5}
adj_comm <- community_path(adjm)
comm_consesusm <- community_path(slate_adj[[1]])

community_similarity(adj_comm,list(comm_consesusm))

```


# GRNBoost2

## Late integration

```{r}
set.seed(1234)
time[["GRNBoost2_late"]] <- system.time(
  late <- infer_networks(count_matrices, 
                                method="GRNBoost2",
                                nCores = 15,
                                grnboost_modules = modules)
)

as.data.frame(late[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 late output")

```

### Symmetrize and ROC

```{r}
late_wadj <- generate_adjacency(late)
slate_wadj <- symmetrize(late_wadj, weight_function = "mean")

as.data.frame(slate_wadj[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 symmetric weighted adjacency")
```


```{r}
late_auc <- plotROC(slate_wadj, adjm, plot_title = "ROC curve - grnboost Late Integration")
```

### Cutoff

```{r}
slate_adj <- cutoff_adjacency(count_matrices = count_matrices,
                                     weighted_adjm_list = slate_wadj, 
                                     n = 3,
                                     method = "GRNBoost2",
                                     nCores = 15,
                                     grnboost_modules = modules)

as.data.frame(slate_adj[[1]]) %>%
  slice_head(n=30) %>% 
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "GRNBoost2 symmetric adjacency")
```


```{r}
scores.late.all <- pscores(adjm, slate_adj)
scores.late.all$Statistics %>%
    datatable(extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('csv', 'excel'),
                scrollX = TRUE,
                pageLength = 10), 
              caption = "scores late")

keepscores <- scores.late.all$Statistics %>% mutate(Predicted_Matrix=c("early"), Method=c("GRNBoost2"), Ratio=nrow(adjm)/ncol(count_matrices[[1]]), p=nrow(adjm), k=length(seq_along(count_matrices))) %>%
  full_join(keepscores)

```


```{r, fig.width=10,fig.width=15}
plotg(slate_adj)
```


### Plot comparison

```{r, fig.width=8,fig.width=8}
compare_consensus(consensus_matrix = slate_adj[[1]], reference_matrix = adjm, false_plot = F)
```


### Community detection

```{r, fig.width=5, fig.height=5}
comm_consesusm <- community_path(slate_adj[[1]])
community_similarity(adj_comm,list(comm_consesusm))

```

# ZILGM

## Late integration

```{r}
#set.seed(1234)
#time[["ZILGM_late_15Cores"]] <- system.time(
#  late <- infer_networks(count_matrices, 
#                         method="ZILGM",
#                         nCores = 15)
#  )
#
#est_graphs <- late$network_results
#lambdas <- late$lambda_results
#```

#```{r}
#### Symmetrize and ROC
#plotROC(lambdas[[1]], adjm, plot_title = "Lambda ROC Matrix1", is_binary = F)
```

### Plot comparison


```{r ZILGM scores late}
#scores.late.all <- pscores(adjm, est_graphs)
#
#scores.late.all$Statistics %>%
#    datatable(extensions = 'Buttons',
#              options = list(
#                dom = 'Bfrtip',
#                buttons = c('csv', 'excel'),
#                scrollX = TRUE,
#                pageLength = 10), 
#              caption = "scores")
#keepscores <- scores.late.all$Statistics %>% mutate(Predicted_Matrix=c("early"), Method=c("ZILGM"), #Ratio=nrow(adjm)/ncol(count_matrices[[1]]), p=nrow(adjm)) %>%
#  full_join(keepscores)

```

```{r}
#plotg(est_graphs)
```

```{r ZILGM compare late, fig.width=8,fig.width=10}
#compare_consensus(est_graphs[[1]], adjm)
```

# Joint Integration

## Joint Random Forest

```{r JRF inference}
#https://cran.r-project.org/src/contrib/Archive/JRF/
#install.packages("/home/francescoc/Downloads/JRF_0.1-4.tar.gz", repos = NULL, type = "source")
#set.seed(1234)
#time[["JRF_15Cores"]] <- system.time(
#  jrf_mat <- infer_networks(count_matrices, method="JRF", nCores = 15)
#)
 
#as.data.frame(jrf_mat[[1]]) %>%
#  slice_head(n=30) %>% 
#    datatable(extensions = 'Buttons',
#              options = list(
#                dom = 'Bfrtip',
#                buttons = c('csv', 'excel'),
#                scrollX = TRUE,
#                pageLength = 10), 
#              caption = "JRF output")

```

### Prepare the output

```{r}
#jrf_list <- list()

#importance_columns <- grep("importance", names(jrf_mat[[1]]), value = TRUE)

#for (i in seq_along(importance_columns)) {
# Select the 'gene1', 'gene2', and the current 'importance' column
#  df <- jrf_mat[[1]][, c("gene1", "gene2", importance_columns[i])]
  
  # Rename the importance column to its original name (e.g., importance1, importance2, etc.)
#  names(df)[3] <- importance_columns[i]
  
  # Add the data frame to the output list
#  jrf_list[[i]] <- df
#}

#as.data.frame(jrf_list[[1]]) %>%
#  slice_head(n=30) %>% 
#    datatable(extensions = 'Buttons',
#              options = list(
#                dom = 'Bfrtip',
#                buttons = c('csv', 'excel'),
#                scrollX = TRUE,
#                pageLength = 10), 
#              caption = "JRF output")
```

### symmetrize Output and ROC

```{r JRF symmetrizeROC late}
#jrf_wadj <- generate_adjacency(jrf_list)
#sjrf_wadj <- symmetrize(jrf_wadj, weight_function = "mean")
#jrf_auc_mine <- plotROC(sjrf_wadj, adjm, plot_title = "ROC curve - JRF Late Integration", is_binary = F)

#as.data.frame(sjrf_wadj[[1]]) %>%
#  slice_head(n=30) %>% 
#    datatable(extensions = 'Buttons',
#              options = list(
#                dom = 'Bfrtip',
#                buttons = c('csv', 'excel'),
#                scrollX = TRUE,
#                pageLength = 10), 
#              caption = "JRF symmetrize output")
```

### Generate Adjacency and Apply Cutoff

```{r JRF cutoff late}
#sjrf_adj <- cutoff_adjacency(count_matrices = count_matrices,
#                 weighted_adjm_list = sjrf_wadj, 
#                 n = 3,
#                 method = "JRF")

#as.data.frame(sjrf_adj[[1]]) %>%
#  slice_head(n=30) %>% 
#    datatable(extensions = 'Buttons',
#              options = list(
#                dom = 'Bfrtip',
#                buttons = c('csv', 'excel'),
#                scrollX = TRUE,
#                pageLength = 10), 
#              caption = "JRF adjacency")

```

### Comparison with the Ground Truth

```{r JRF metrics late}
#scores.jrf.all <- pscores(adjm, sjrf_adj)

#scores.jrf.all$Statistics %>%
#    datatable(extensions = 'Buttons',
#              options = list(
#                dom = 'Bfrtip',
#                buttons = c('csv', 'excel'),
#                scrollX = TRUE,
#               pageLength = 10), 
#              caption = "scores")

#keepscores <- scores.jrf.all$Statistics %>% mutate(Predicted_Matrix=c("early"), Method=c("JRF"), Ratio=nrow(adjm)/ncol(count_matrices[[1]]), p=nrow(adjm), k=length(seq_along(count_matrices))) %>%
#  full_join(keepscores)

```

```{r JRF plotg late, fig.width=10,fig.width=15}
#plotg(sjrf_adj)
```

```{r JRF compare late, fig.width=8,fig.width=8}
#compare_consensus(consensus_matrix = sjrf_adj[[1]], reference_matrix = adjm, false_plot = F)
```


### Community detection

```{r, fig.width=5, fig.height=5}
#comm_consesusm <- community_path(sjrf_adj[[1]])

#community_similarity(adj_comm,list(comm_consesusm))

```


# Method Comparison

```{r}
time_data<- data.frame(
  Method = names(time),
  Time_in_Seconds = sapply(time, function(x) if ("elapsed" %in% names(x)) x["elapsed"] else NA)
) %>%
  mutate(
    Time_in_Minutes = Time_in_Seconds / 60,
    Time_in_Hours = Time_in_Seconds / 3600,
    Ratio = nrow(adjm) / ncol(count_matrices[[1]]),
    p = nrow(adjm)
  ) %>%
  arrange(Time_in_Hours) %>%
  mutate(Method = factor(Method, levels = Method)) %>%
  separate(Method, into = c("Method", "Predicted_Matrix", "Cores"), sep = "_", fill = "right") %>%
  mutate(
    Predicted_Matrix = ifelse(Method == "JRF", "joint", Predicted_Matrix),
    Cores = case_when(
      Method %in% c("JRF", "GRNBoost2") ~ "15Cores",
      TRUE ~ Cores
    )
  )

df2 <- keepscores %>%
  mutate(
    Predicted_Matrix_Mapped = case_when(
      Method == "JRF" ~ "joint",
      Predicted_Matrix == "early" ~ "late",
      Predicted_Matrix %in% c("vote", "union", "inet") ~ "late",
      TRUE ~ Predicted_Matrix
    )
  )


df1_unique <- time_data %>%
  dplyr::select(Method, Predicted_Matrix, Time_in_Seconds, Time_in_Minutes, Time_in_Hours) %>%
  distinct()

df2 <- df2 %>%
  left_join(df1_unique, by = c("Method", "Predicted_Matrix_Mapped" = "Predicted_Matrix")) %>%
  dplyr::select(-Predicted_Matrix_Mapped)
df2 <- rbind(df2,df2)
df2$Predicted_Matrix <- c("late", "late","early","early")
write.table(df2, file.path(ddir, "met_n100_p500_k1.txt"), quote = FALSE, col.names = TRUE, row.names = FALSE, sep = "\t")

```


```{r}
count_matrices_all <- readRDS("./../analysis/simulation/simdata/sim_n100p500k5.RDS")
count_matrices_all <- lapply(count_matrices_all, t)

for (k in 2:5) {
  cat("Processing k =", k, "\n")
  count_matrices_k <- count_matrices_all[1:k]
  early_matrix <- list(earlyj(lapply(count_matrices_k, as.matrix), rowg = TRUE))

  methods <- c("GENIE3", "GRNBoost2", "JRF")
  keepscores <- data.frame()
  time <- list()

  for (method in methods) {
    cat("  - Method:", method, "\n")

    ## LATE INTEGRATION
    set.seed(1234)
    time[[paste0(method, "_late_15Cores_k", k)]] <- system.time({
      if (method == "GRNBoost2") {
        late <- infer_networks(count_matrices_k, method = method, nCores = 15, grnboost_modules = modules)
      } else {
        late <- infer_networks(count_matrices_k, method = method, nCores = 15)
      }
    })

    if (method == "JRF") {
      importance_columns <- grep("importance", names(late[[1]]), value = TRUE)
      late_list <- lapply(importance_columns, function(col) {
        df <- late[[1]][, c("gene1", "gene2", col)]
        names(df)[3] <- col
        df
      })
    } else {
      late_list <- late
    }

    late_wadj <- generate_adjacency(late_list)
    slate_wadj <- symmetrize(late_wadj, weight_function = "mean")
    slate_adj <- cutoff_adjacency(count_matrices = count_matrices_k,
                                  weighted_adjm_list = slate_wadj,
                                  n = 3,
                                  method = method,
                                  nCores = 15,
                                  grnboost_modules = modules)

    cons_vote <- create_consensus(slate_adj, method = "vote")
    cons_union <- create_consensus(slate_adj, method = "union")
    cons_inet <- create_consensus(adj_matrix_list = slate_adj, weighted_list = slate_wadj,
                                  method = "INet", threshold = ifelse(method == "JRF", 0.1, 0.05), ncores = 15)

    consensus_scores <- pscores(adjm, list(cons_vote, cons_union, cons_inet))
    keepscores <- consensus_scores$Statistics %>%
      mutate(Predicted_Matrix = c("vote", "union", "inet"),
             Method = method,
             Ratio = nrow(adjm)/ncol(count_matrices_k[[1]]),
             p = nrow(adjm),
             k = k) %>%
      bind_rows(keepscores)

    ## EARLY INTEGRATION (for GENIE3, GRNBoost2)
    if (method %in% c("GENIE3", "GRNBoost2")) {
      set.seed(1234)
      time[[paste0(method, "_early_15Cores_k", k)]] <- system.time({
        if (method == "GRNBoost2") {
          early <- infer_networks(early_matrix, method = method, nCores = 15, grnboost_modules = modules)
        } else {
          early <- infer_networks(early_matrix, method = method, nCores = 15)
        }
      })

      early_wadj <- generate_adjacency(early)
      searly_wadj <- symmetrize(early_wadj, weight_function = "mean")
      searly_adj <- cutoff_adjacency(count_matrices = early_matrix,
                                     weighted_adjm_list = searly_wadj,
                                     n = 2,
                                     method = method,
                                     nCores = 15,
                                     grnboost_modules = modules)

      scores_early <- pscores(adjm, searly_adj)

      keepscores <- scores_early$Statistics %>%
        mutate(Predicted_Matrix = "early",
               Method = method,
               Ratio = nrow(adjm)/ncol(count_matrices_k[[1]]),
               p = nrow(adjm),
               k = k) %>%
        bind_rows(keepscores)
    }
  }

  ## Time summary
  df_time <- data.frame(
    Method = names(time),
    Time_in_Seconds = sapply(time, function(x) if ("elapsed" %in% names(x)) x["elapsed"] else NA)
  ) %>%
    mutate(
      Time_in_Minutes = Time_in_Seconds / 60,
      Time_in_Hours = Time_in_Seconds / 3600,
      Ratio = nrow(adjm) / ncol(count_matrices_k[[1]]),
      p = nrow(adjm)
    ) %>%
    separate(Method, into = c("Method", "Predicted_Matrix", "Cores", "kval"), sep = "_", fill = "right") %>%
    mutate(Predicted_Matrix = ifelse(Method == "JRF" & Predicted_Matrix == "late", "joint", Predicted_Matrix))

  df2 <- keepscores %>%
    mutate(Predicted_Matrix_Mapped = case_when(
      Method == "JRF" ~ "joint",
      Predicted_Matrix == "early" ~ "early",
      Predicted_Matrix %in% c("vote", "union", "inet") ~ "late",
      TRUE ~ Predicted_Matrix
    ))

  df1_unique <- df_time %>%
    dplyr::select(Method, Predicted_Matrix, Time_in_Seconds, Time_in_Minutes, Time_in_Hours) %>%
    distinct()

  df2 <- df2 %>%
    left_join(df1_unique, by = c("Method", "Predicted_Matrix_Mapped" = "Predicted_Matrix")) %>%
    dplyr::select(-Predicted_Matrix_Mapped)

  write.table(df2, file.path(ddir, paste0("met_n100_p500_k", k, ".txt")),
              quote = FALSE, col.names = TRUE, row.names = FALSE, sep = "\t")
}

```





















```{r}
count_matrices_all <- readRDS("./../analysis/simulation/simdata/sim_n100p500k5.RDS")
count_matrices_all <- lapply(count_matrices_all, t)

for (k in 2:5) {
  cat("Processing k =", k, "\n")
  count_matrices_k <- count_matrices_all[1:k]
  early_matrix <- list(earlyj(lapply(count_matrices_k, as.matrix), rowg = TRUE))

  methods <- c("GENIE3", "GRNBoost2", "ZILGM", "JRF")
  keepscores <- data.frame()
  time <- list()

  for (method in methods) {
    cat("  - Method:", method, "\n")

    ## LATE INTEGRATION
    set.seed(1234)
    time[[paste0(method, "_late_15Cores_k", k)]] <- system.time({
      if (method == "GRNBoost2") {
        late <- infer_networks(count_matrices_k, method = method, nCores = 15, grnboost_modules = modules)
      } else {
        late <- infer_networks(count_matrices_k, method = method, nCores = 15)
      }
    })

    if (method == "JRF") {
      importance_columns <- grep("importance", names(late[[1]]), value = TRUE)
      late_list <- lapply(importance_columns, function(col) {
        df <- late[[1]][, c("gene1", "gene2", col)]
        names(df)[3] <- col
        df
      })
    } else if (method == "ZILGM") {
      est_graphs <- late$network_results
      est_graphs <- lapply(est_graphs, as.matrix)

      consesusm <- create_consensus(est_graphs, method = "vote")
      consesusu <- create_consensus(est_graphs, method = "union")

      scores.late <- pscores(adjm, list(consesusm, consesusu))

      keepscores <- scores.late$Statistics %>%
        mutate(Predicted_Matrix = c("vote", "union"),
               Method = method,
               Ratio = nrow(adjm)/ncol(count_matrices_k[[1]]),
               p = nrow(adjm),
               k = k) %>%
        bind_rows(keepscores)

      next
    } else {
      late_list <- late
    }

    late_wadj <- generate_adjacency(late_list)
    slate_wadj <- symmetrize(late_wadj, weight_function = "mean")
    slate_adj <- cutoff_adjacency(count_matrices = count_matrices_k,
                                   weighted_adjm_list = slate_wadj,
                                   n = 3,
                                   method = method,
                                   nCores = 15,
                                   grnboost_modules = modules)

    cons_vote <- create_consensus(slate_adj, method = "vote")
    cons_union <- create_consensus(slate_adj, method = "union")
    cons_inet <- create_consensus(adj_matrix_list = slate_adj, weighted_list = slate_wadj,
                                   method = "INet", threshold = ifelse(method == "JRF", 0.1, 0.05), ncores = 15)

    consensus_scores <- pscores(adjm, list(cons_vote, cons_union, cons_inet))
    keepscores <- consensus_scores$Statistics %>%
      mutate(Predicted_Matrix = c("vote", "union", "inet"),
             Method = method,
             Ratio = nrow(adjm)/ncol(count_matrices_k[[1]]),
             p = nrow(adjm),
             k = k) %>%
      bind_rows(keepscores)

    ## EARLY INTEGRATION (for GENIE3, GRNBoost2, ZILGM)
    if (method %in% c("GENIE3", "GRNBoost2", "ZILGM")) {
      set.seed(1234)
      time[[paste0(method, "_early_15Cores_k", k)]] <- system.time({
        if (method == "GRNBoost2") {
          early <- infer_networks(early_matrix, method = method, nCores = 15, grnboost_modules = modules)
        } else {
          early <- infer_networks(early_matrix, method = method, nCores = 15)
        }
      })

      if (method == "ZILGM") {
        est_graphs <- early$network_results
        est_graphs <- lapply(est_graphs, as.matrix)

        consesusm <- create_consensus(est_graphs, method = "vote")
        consesusu <- create_consensus(est_graphs, method = "union")

        scores_early <- pscores(adjm, list(consesusm, consesusu))

        keepscores <- scores_early$Statistics %>%
          mutate(Predicted_Matrix = c("early", "early"),
                 Method = method,
                 Ratio = nrow(adjm)/ncol(count_matrices_k[[1]]),
                 p = nrow(adjm),
                 k = k) %>%
          bind_rows(keepscores)

      } else {
        early_wadj <- generate_adjacency(early)
        searly_wadj <- symmetrize(early_wadj, weight_function = "mean")
        searly_adj <- cutoff_adjacency(count_matrices = early_matrix,
                                        weighted_adjm_list = searly_wadj,
                                        n = 2,
                                        method = method,
                                        nCores = 15,
                                        grnboost_modules = modules)

        scores_early <- pscores(adjm, searly_adj)

        keepscores <- scores_early$Statistics %>%
          mutate(Predicted_Matrix = "early",
                 Method = method,
                 Ratio = nrow(adjm)/ncol(count_matrices_k[[1]]),
                 p = nrow(adjm),
                 k = k) %>%
          bind_rows(keepscores)
      }
    }
  }

  ## Time summary
  df_time <- data.frame(
    Method = names(time),
    Time_in_Seconds = sapply(time, function(x) if ("elapsed" %in% names(x)) x["elapsed"] else NA)
  ) %>%
    mutate(
      Time_in_Minutes = Time_in_Seconds / 60,
      Time_in_Hours = Time_in_Seconds / 3600,
      Ratio = nrow(adjm) / ncol(count_matrices_k[[1]]),
      p = nrow(adjm)
    ) %>%
    separate(Method, into = c("Method", "Predicted_Matrix", "Cores", "kval"), sep = "_", fill = "right") %>%
    mutate(Predicted_Matrix = ifelse(Method == "JRF" & Predicted_Matrix == "late", "joint", Predicted_Matrix))

  df2 <- keepscores %>%
    mutate(Predicted_Matrix_Mapped = case_when(
      Method == "JRF" ~ "joint",
      Predicted_Matrix == "early" ~ "early",
      Predicted_Matrix %in% c("vote", "union", "inet") ~ "late",
      TRUE ~ Predicted_Matrix
    ))

  df1_unique <- df_time %>%
    dplyr::select(Method, Predicted_Matrix, Time_in_Seconds, Time_in_Minutes, Time_in_Hours) %>%
    distinct()

  df2 <- df2 %>%
    left_join(df1_unique, by = c("Method", "Predicted_Matrix_Mapped" = "Predicted_Matrix")) %>%
    dplyr::select(-Predicted_Matrix_Mapped)

  write.table(df2, file.path(ddir, paste0("met_n100_p500_k", k, ".txt")),
              quote = FALSE, col.names = TRUE, row.names = FALSE, sep = "\t")
}
```

```{r}
sessionInfo()
```

